<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Hypervault</title>

<link rel="stylesheet" type="text/css" href="css/picnic-v2.min.css">
<style type="text/css">
#title {
  font-family: "Raleway", "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 300%;
  font-weight: lighter;
  letter-spacing: 4px;
  color: #FF4136;
}

#container {
  padding: 0px 30px 0px 30px;
  width: 600px;
  margin-left: auto;
  margin-right: auto;
  margin-top: 100px;

  border: 1px solid #FF851B;
  border-radius: 12px;
  height: 350px;
}
</style>

<script src="cryptojs-aes.min.js"></script>
<script src="filesaver.js"></script>
<script src="base64-binary.js"></script>

<script>

//////////////////////////////////////////////////////////////////////////////////// Read file stuff
var globalFileData = {name:"", type:"", data:""};
var fileDataRaw = "";

function readFileData(fileObj, callback) {
  var reader = new FileReader();

  reader.onload = (function(theFile) {
    return function(e) {
      callback(theFile.name, theFile.type, e.target.result);
    };
  })(fileObj);

  // Read in the image file as a data URL.
  // reader.readAsArrayBuffer
  reader.readAsDataURL(fileObj);
}

function getFileData() {
  var fileList = document.getElementById("uploadInput").files;
  var file1 = fileList[0];
  readFileData(file1, function (fileName, fileType, fileData) {
      fileDataRaw = fileData;
      globalFileData['name'] = fileName;
      globalFileData['type'] = fileType;
      globalFileData['data'] = fileData;
      console.log('File name:' + fileName);
      console.log('File type:' + fileType);
      console.log(fileData);
  });
}

/////////////////////////////////////////////////////////////////////////////////// Encryption stuff
function hex2a(hex) {
  var str = '';
  for (var i = 0; i < hex.length; i += 2)
      str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
  return str;
}

function encryptFileData(fileData, passcode) {
  var encrypted = CryptoJS.AES.encrypt(fileData, passcode);
  return encrypted;
}

function decryptFileData(cipherData, passcode) {
  var decrypted = CryptoJS.AES.decrypt(cipherData, passcode);
  return hex2a(decrypted.toString())
}

//////////////////////////////////////////////////////////////////////////////////// Vault rendering

function getVaultTemplate(callback) {
  url = "vault.html"
  var xhr = new XMLHttpRequest();
  xhr.open("GET", url, true);
  xhr.onreadystatechange = function() {
    if (xhr.readyState == 4) {
      callback(xhr.responseText);
    }
  }
  xhr.send();
}

function stripDataPrefix(dataUrl) {
  var firstCommaIndex = dataUrl.indexOf(',');
  return dataUrl.slice(firstCommaIndex+1);
}

function renderVault(fileName, fileType, fileData, callback) {
  getVaultTemplate(function (vaultTemplate) {
    // Replace the 3 placeholders with the file name, file type, and file data
    var vault = vaultTemplate.replace('REPLACE_WITH_FILE_NAME', fileName)
      .replace('REPLACE_WITH_FILE_TYPE', fileType)
      .replace('REPLACE_WITH_FILE_DATA', fileData);
    callback(vault);
  });
}

function saveVault(vaultData, vaultFileName) {
  var vaultBlob = new Blob([vaultData], {type: "text/html;charset=utf-8"});
  saveAs(vaultBlob, vaultFileName);
}

function createVault() {
  var password = document.getElementById('password_input').value;
  var base64FileData = stripDataPrefix(globalFileData['data']);
  var encryptedData = encryptFileData(base64FileData, password);

  renderVault(globalFileData['name'], globalFileData['type'], encryptedData, function (vaultData) {
    saveVault(vaultData, "vault1.html");
  });
}

</script>
</head>
<body>

<div id="container">
  <p id="title">Hypervault</p>

  <p>
  <form name="uploadForm">
    <input id="uploadInput" type="file" name="myFiles" onchange="getFileData();" multiple>
  </form>
  </p>

  <p>
    <input type="password" name="password_input" id="password_input" placeholder="Password">
  </p>

  <button onclick="createVault()">Encrypt</button>
</div>

</body>
</html>
